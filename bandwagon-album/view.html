{{- $tags := .Tags -}}
{{- $songs := .Children.Top60.ByRank.Slice -}}
{{- $canEdit := .UserCan "edit" -}}
{{- $isPlayable := false -}}
{{- $links := .Data "links" -}}

{{- range $index, $song := $songs -}}
	{{- if ne nil $song.Data.attachmentId -}}
		{{- $isPlayable = true -}}
	{{- end -}}
{{- end -}}

<div class="page">

	<style>
		{{template "stylesheet" .}}
	</style>

	<!-- First Row: Album Name and Artwork -->
	<div class="md:flex-row margin-bottom">
		<div class="md:width-256 flex-shrink-0">
			{{- if ne "" .IconURL -}}
				<img src="{{.IconURL}}" class="width-100-percent aspect-square" aria-hidden="true" style="object-fit:cover;">
			{{- else if $canEdit -}}
				<div class="aspect-square text-center flex-column flex-justify-center flex-align-center" style="border:solid 1px var(--black)" script="install blockselect()">
					<a hx-get="/{{.StreamID}}/edit" class="text-plain">Click here to add album art</a>
				</div>
			{{- end -}}
		</div>
		<div class="md:width-32"></div>
		<div class="flex-grow-1">
			<div class="text-lg margin-top-none">
				<a hx-get="/@{{.ParentID}}" href="/@{{.ParentID}}" class="turboclick" aria-label="Artist: {{.AttributedTo.Name}}">
					{{.AttributedTo.Name}}
				</a> 
			</div>
			<h1 class="margin-vertical-none">{{.Label}}</h1>
			{{ if ne nil (.Data "year") -}}
				<div class="margin-bottom text-gray">{{.Data "year"}}</div>
			{{- end -}}
			<!--div>
				{{- range $index, $tag := $tags -}}
					{{- if eq "Hashtag" $tag.Type}}
						{{- if ne 0 $index -}},&nbsp;{{- end -}}
						<a href="{{$tag.Href}}">{{$tag.Name}}</a>
					{{- end -}}
				{{- end -}}
			</div-->
			<div class="margin-vertical"></div>
 
			{{- if $isPlayable -}}
				<div id="media-controls" class="margin-vertical-lg">
					<button hx-on:click="PlayFirst()" class="primary playing-hide">{{icon "play-fill"}} Play Album</button>
					<button hx-on:click="PlayPrevious()" class="primary playing-show margin-right-none">{{icon "skip-backward-fill"}}</button>
					<button hx-on:click="Pause()" class="primary playing-show margin-right-none">{{icon "pause-fill"}}</button>
					<button hx-on:click="PlayNext()" class="primary playing-show">{{icon "skip-forward-fill"}}</button>
				</div>
			{{- else if $canEdit -}}
				<div class="margin-vertical-lg" role="presentation">
					<div>
						<button disabled>{{icon "play-fill"}} Play Album</button>
					</div>
					<div class="text-sm text-gray italics">Upload audio files to enable playback</div>
				</div>
			{{- end -}}

			<div>
				<span class="link" role="button" hx-get="/{{.StreamID}}/share?content={{.Label}} {{.Permalink}}">Share Album <span role="presentation" class="margin-left-xs">{{icon "share"}}</span></span>
			</div>
		</div>
	</div>

	<!-- Second Row: -->
	<div class="md:flex-row-reverse">

		<!-- Song List -->
		<div class="flex-grow-1">

			{{- if $songs.IsEmpty -}}
			
				{{- if $canEdit -}}
					<div class="margin-vertical-lg">
						<button class="primary" hx-get="/{{.StreamID}}/add-song"><td><span role="presentation">{{icon "plus"}}</span> Add the first song to this album</button>
					</div>
				{{- end -}}
			{{- else -}}
				<form hx-post="/{{.StreamID}}/sort-tracks" hx-trigger="end">
					<table class="table">
						<tbody id="track-list">
							{{- range $index, $song := $songs -}}
								{{- $isplayable := ne nil $song.Data.attachmentId -}}
								<tr id="track-{{$index}}" class="track hover-trigger" role="button">
									<input type="hidden" name="keys" value="{{.StreamID}}">
									{{- if and $canEdit (gt $songs.Length 1) -}}
										<td class="">
											<span class="drag-handle">{{icon "drag-handle"}}</span>
										</td>
									{{- end -}}

									<td nowrap
										{{ if $isplayable -}}
											hx-on:click="Toggle({{$index}})"
										{{- else -}}
											hx-get="/{{$song.StreamID}}"
										{{- end -}}
									>

										<span class="margin-right text-gray">
											{{- if $isplayable -}}
											<span class="hover-show">{{icon "play-fill"}}</span>
												{{- if eq $song.IsFeatured true -}}
													<span class="hover-hide">{{icon "star-fill"}}</span>
												{{- else -}}
													<span class="invisible hover-hide">{{icon "play-fill"}}</span>
													{{- end -}}
											{{- else -}}
												{{- if eq $song.IsFeatured true -}}
													{{icon "star-fill"}}
												{{- end -}}
											{{- end -}}
										</span>
									</td>
									<td nowrap class="align-right"
										{{ if $isplayable -}}
											hx-on:click="Toggle({{$index}})"
										{{- else -}}
											hx-get="/{{$song.StreamID}}"
										{{- end -}}
									>
										<span class="hide sm:show">{{add $index 1}}.</span>
									</td>
									<td class="width-100-percent"
										{{ if $isplayable -}}
											hx-on:click="Toggle({{$index}})"
										{{- else -}}
											hx-get="/{{$song.StreamID}}"
										{{- end -}}
									>
										{{$song.Label}}
										{{ if eq true $song.Data.explicit }}<span class="text-gray text-xs margin-left-sm">{{icon "explicit-fill"}}</span>{{ end }}
									</td>
									<td nowrap class="align-right"
										{{ if $isplayable -}}
											hx-on:click="Toggle({{$index}})"
										{{- else -}}
											hx-get="/{{$song.StreamID}}"
										{{- end -}}
									>
										{{- $song.Data.length -}}
									</td>
									<td class="text-xs align-right" nowrap>
										<button hx-get="/{{$song.StreamID}}" class="margin-right-none margin-left-sm" aria-label="Song Details">{{icon "more-horizontal"}}</button>
										{{- if $canEdit -}}
											<button hx-get="/{{$song.StreamID}}/edit" class="margin-right-none margin-left-sm">Edit</button>
										{{- end -}}
									</td>
								</tr>
							{{- end -}}

							{{- if $canEdit -}}
								<tr hx-get="/{{.StreamID}}/add-song" role="button">
									<td colspan="6" class="link">
										<span role="presentation">{{icon "add"}}</span> Add Another Song
									</td>
								</tr>
							{{- end -}}

						</tbody>
					</table>
				</form>

			{{- end -}}

		</div>

		<div class="md:width-32 flex-shrink-0 flex-grow-0"></div>
		<div class="md:width-256 flex-shrink-0">

			{{- if ne "" .Summary -}}
				<div class="margin-bottom-lg">
					<h3>Album Notes</h3>
					{{.Summary | markdown}}
				</div>
			{{- end -}}


			{{- if $links.NotEmpty -}}

				<h3>Listen on Streaming Services</h3>
				{{- range $key, $value := $links -}}
					
					{{- if ne "" $value -}}
						{{- $icon := "music-note-beamed" -}}
						{{- $label := $value -}}

						{{- if eq "APPLE" $key -}}
							{{- $icon = "apple" -}}
							{{- $label = "Apple Music" -}}

						{{- else if eq "SPOTIFY" $key -}}
							{{- $label = "Spotify" -}}
							{{- $icon = "spotify" -}}

						{{- else if eq "YOUTUBE" $key -}}
							{{- $label = "YouTube Music" -}}
							{{- $icon = "youtube" -}}

						{{- else if eq "SOUNDCLOUD" $key -}}
							{{- $label = "SoundCloud" -}}
							{{- $icon = "cloud" -}}

						{{- else if eq "TIDAL" $key -}}
							{{- $label = "Tidal" -}}

						{{- else if eq "AMAZON" $key -}}
							{{- $label = "Amazon Music" -}}
							{{- $icon = "amazon" -}}

						{{- else if eq "GOOGLE" $key -}}
							{{- $label = "Google Play" -}}
							{{- $icon = "google" -}}

						{{- else if eq "PANDORA" $key -}}
							{{- $label = "Pandora" -}}

						{{- else if eq "IHEARTRADIO" $key -}}
							{{- $label = "iHeartRadio" -}}

						{{- else -}}
							{{- $label = domainOnly $value -}}

						{{- end -}}

						<a href="{{$value}}" target="_blank">
							<i class="bi bi-{{$icon}}"></i> {{ $label }}
						</a><br>
					{{- end -}}

				{{- end -}}
				<br>
			{{- end -}}

		</div>

	</div>

	<audio hx-on:ended="PlayNext()">
		<source id="source-aac" type="audio/aac">
		<source id="source-mp3" type="audio/mp3">
	</audio>

	<script src="/.templates/bandwagon-album/javascript" preload></script>
	<script type="application/javascript">
		var playlist = [
		{{- $first := true -}}
		{{- range $index, $song := $songs -}}
			{{- if ne nil $song.Data.attachmentId -}}
				{{- if not $first -}},{{- end -}}
				{{- $first = false -}}
				{"index":{{$index}}, "url":"/{{$song.StreamID}}/attachments/{{$song.Data.attachmentId}}", "title":"{{$song.Label}}"}
			{{ end -}}
		{{- end -}}
		]
	</script>

	{{- if $canEdit -}}
		<div class="pos-absolute-top-right text-sm">
			<button hx-get="/{{.StreamID}}/edit">Edit Album</button>
			<button hx-get="/{{.StreamID}}/add-song"><span aria-label="Add">{{icon "add"}}</span> Song</button>
		</div>

		<script src="/.themes/global/resources/sortable-1.15.0/Sortable.min.js" preload></script>

		<script>
			new Sortable(document.getElementById("track-list"), {
				handle: ".drag-handle",
				animation: 150,
				whisperClass: 'draggable-whisper'
			});
		</script>

		<style>
			.drag-handle {
				cursor:grab;
			}

			.draggable-whisper {
				background-color: var(--gray50);
				color:var(--gray50);
				cursor: grabbing;
			}
		</style>
	{{- end -}}

	<div hx-get="/{{.StreamID}}" hx-trigger="refreshPage from:window"></div>

</div>